<?xml version="1.0" encoding="UTF-8"?>
<project>
  <actions/>
  <description>Regression/delta test for the LOFAR calibration pipeline.
Triggers after a build on changes in the trunk at 2:00 AM</description>
  <logRotator>
    <daysToKeep>-1</daysToKeep>
    <numToKeep>15</numToKeep>
    <artifactDaysToKeep>-1</artifactDaysToKeep>
    <artifactNumToKeep>-1</artifactNumToKeep>
  </logRotator>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.plugins.redmine.RedmineProjectProperty>
      <redmineWebsite>https://support.astron.nl/lofar_issuetracker/</redmineWebsite>
      <projectName>lofarsys</projectName>
      <redmineVersion>true</redmineVersion>
    </hudson.plugins.redmine.RedmineProjectProperty>
  </properties>
  <scm class="hudson.scm.SubversionSCM">
    <locations>
      <hudson.scm.SubversionSCM_-ModuleLocation>
        <remote>https://svn.astron.nl/LOFAR/trunk/CEP</remote>
        <local>LOFAR/CEP</local>
      </hudson.scm.SubversionSCM_-ModuleLocation>
      <hudson.scm.SubversionSCM_-ModuleLocation>
        <remote>https://svn.astron.nl/LOFAR/trunk/CMake</remote>
        <local>LOFAR/CMake</local>
      </hudson.scm.SubversionSCM_-ModuleLocation>
    </locations>
    <browser class="hudson.plugins.viewVC.ViewVCRepositoryBrowser">
      <url>https://svn.astron.nl/</url>
      <location>LOFAR</location>
    </browser>
    <excludedRegions/>
    <includedRegions/>
    <excludedUsers/>
    <excludedRevprop/>
    <excludedCommitMessages/>
    <workspaceUpdater class="hudson.scm.subversion.UpdateUpdater"/>
  </scm>
  <assignedNode>LCE072</assignedNode>
  <canRoam>false</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <jdk>(Default)</jdk>
  <triggers class="vector">
    <hudson.triggers.SCMTrigger>
      <spec>0 2 * * *</spec>
    </hudson.triggers.SCMTrigger>
  </triggers>
  <concurrentBuild>true</concurrentBuild>
  <customWorkspace>/home/lofarbuild/jenkins_builds/msss_calibrator</customWorkspace>
  <builders>
    <hudson.plugins.cmake.CmakeBuilder>
      <sourceDir>LOFAR</sourceDir>
      <buildDir>gnu_debug</buildDir>
      <installDir>install</installDir>
      <buildType>Debug</buildType>
      <otherBuildType/>
      <generator>Unix Makefiles</generator>
      <makeCommand>make -j8</makeCommand>
      <installCommand>make install -j8</installCommand>
      <preloadScript/>
      <cmakeArgs>-Wdev -DBUILD_ASKAPsoft=OFF  -DUSE_OPENMP=ON -DBUILD_PACKAGES=Offline </cmakeArgs>
      <projectCmakePath/>
      <cleanBuild>false</cleanBuild>
      <cleanInstallDir>false</cleanInstallDir>
      <builderImpl/>
    </hudson.plugins.cmake.CmakeBuilder>
    <hudson.tasks.Shell>
      <command># This command will perform the actual regression test steps

# 1. A unit test
ctest -R pipeline

# 2. set environment
. /opt/cep/login/bashrc
use LofIm
export PYTHONPATH=$WORKSPACE/install/lib/python2.6/dist-packages:$PYTHONPATH

# 3. run the pipeline
#remove old state file 
rm -f $WORKSPACE/install/var/run/pipeline/jobs/Observation64405/statefile

# remove old data products
ssh lce068 "rm -rf /data/scratch/lofarbuild/Observation64405/*"
ssh lce069 "rm -rf /data/scratch/lofarbuild/Observation64405/*"

mkdir -p $WORKSPACE/install/var/run/pipeline

#copy the config file to a 'writable' location
cp $WORKSPACE/install/share/pipeline/pipeline.cfg $WORKSPACE/install/var/run/pipeline/pipeline_copy.cfg 

# replace clusterdesc file in the cfg file: allows running in lce072
sed -i 's/cep2.clusterdesc/cep1_test.clusterdesc/g' $WORKSPACE/install/var/run/pipeline/pipeline_copy.cfg 
cd $WORKSPACE/install/bin

# Copy the parsetfile from a local to a global location
mkdir -p $WORKSPACE/parset_files
cp /data/lofar/testdata/CEP/Pipeline/calibrator_pipeline/Observation64405  $WORKSPACE/parset_files/Observation64405  

# Run the calibrator with adapted cfg file
python msss_calibrator_pipeline.py $WORKSPACE/parset_files/Observation64405 -c $WORKSPACE/install/var/run/pipeline/pipeline_copy.cfg  -d

# 4. Test correct functioning
#  a. copy target image data to the scratch directory
rm -rf /data/scratch/lofarbuild/pipeline_regression_test/calibrator
mkdir -p /data/scratch/lofarbuild/pipeline_regression_test/calibrator

# copy target data
scp -r /data/lofar/testdata/CEP/Pipeline/calibrator_pipeline/datasets/*.INST /data/scratch/lofarbuild/pipeline_regression_test/calibrator

# copy the run results
scp -r lce068:/data/scratch/lofarbuild/calibrator_test/L64405_SAP000_SB000_inst.INST /data/scratch/lofarbuild/pipeline_regression_test/calibrator/L64405_SAP000_SB000_inst.INST.result 

scp -r lce069:/data/scratch/lofarbuild/calibrator_test/L64405_SAP000_SB001_inst.INST /data/scratch/lofarbuild/pipeline_regression_test/calibrator/L64405_SAP000_SB001_inst.INST.result

# c. Do actual comparison
#cd /data/scratch/lofarbuild/pipeline
# first sb
python $WORKSPACE/LOFAR/CEP/Pipeline/test/regression_tests/calibrator_pipeline.py /data/scratch/lofarbuild/pipeline_regression_test/calibrator/L64405_SAP000_SB000_inst.INST /data/scratch/lofarbuild/pipeline_regression_test/calibrator/L64405_SAP000_SB000_inst.INST.result 0.0001

#second subband
python $WORKSPACE/LOFAR/CEP/Pipeline/test/regression_tests/calibrator_pipeline.py /data/scratch/lofarbuild/pipeline_regression_test/calibrator/L64405_SAP000_SB001_inst.INST /data/scratch/lofarbuild/pipeline_regression_test/calibrator/L64405_SAP000_SB001_inst.INST.result 0.0001

# 5 remove the pipeline products
# On failure of the test this delete step is not performed and the data can be inspected
# ***************** DANGER: HERE BE DRAGONS!!*************
#ssh lce069 "rm -rf /data/scratch/lofarbuild/out/*"
#rm /home/lofarbuild/jenkins_builds/install/var/run/pipeline/jobs/out/statefile
# ***************** DANGER: HERE BE DRAGONS!!*************
</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.plugins.warnings.WarningsPublisher>
      <healthy/>
      <unHealthy/>
      <thresholdLimit>low</thresholdLimit>
      <pluginName>[WARNINGS] </pluginName>
      <defaultEncoding/>
      <canRunOnFailed>true</canRunOnFailed>
      <useDeltaValues>false</useDeltaValues>
      <thresholds>
        <unstableTotalAll/>
        <unstableTotalHigh/>
        <unstableTotalNormal/>
        <unstableTotalLow/>
        <unstableNewAll/>
        <unstableNewHigh/>
        <unstableNewNormal/>
        <unstableNewLow/>
        <failedTotalAll/>
        <failedTotalHigh/>
        <failedTotalNormal/>
        <failedTotalLow/>
        <failedNewAll/>
        <failedNewHigh/>
        <failedNewNormal/>
        <failedNewLow/>
      </thresholds>
      <shouldDetectModules>false</shouldDetectModules>
      <dontComputeNew>false</dontComputeNew>
      <parserConfigurations/>
      <consoleLogParsers>
        <string>GNU compiler 4 (ld)</string>
        <string>GNU compiler 4 (gcc)</string>
      </consoleLogParsers>
    </hudson.plugins.warnings.WarningsPublisher>
  </publishers>
  <buildWrappers>
    <hudson.plugins.timestamper.TimestamperBuildWrapper/>
  </buildWrappers>
</project>