#!/bin/bash

#
# Template engine for LOFAR
#
#   Reads stdin, replaces variables, writes stdout.
#
#   Variables replaced:
#       ${BRANCH_NAME}  = Name of this branch, relative to root
#       ${BRANCH_URL}   = Full subversion URL for this branch
#       ${REVISION}     = SVN revision number of this checkout (or HEAD if trunk)
#       ${NOW}          = now in UTC (format: 2016-01-01 10:11:12)
#       ${BUILD_UID}    = uid of building user (=caller)
#

# ----- BRANCH_NAME = branches/LOFAR-Task1234 -----
# ----- BRANCH_NAME = trunk -----
# ----- BRANCH_NAME = tags/LOFAR-Release-2_15_1 -----
# ----- BRANCH_NAME = UNKNOWN -----

# Make sure we obtain info about the project source!
SVN_INFO=`@Subversion_SVN_EXECUTABLE@ info @PROJECT_SOURCE_DIR@`

# Extract repository root, e.g. https://svn.astron.nl/LOFAR
REPO=`echo "$SVN_INFO" | perl -ne 'print "$1" if /Repository Root: +(.+)/;'`

# Extract branch URL, e.g. https://svn.astron.nl/LOFAR/branches/LOFAR-Task1234
URL=`echo "$SVN_INFO" | perl -ne 'print "$1" if /URL: +(.+)/;'`

# Extract branch name w.r.t. repository root, e.g. branches/LOFAR-Task1234
BRANCH=`echo "$URL" | perl -ne 'print "$1" if m|^\Q'"$REPO"'\E/?(.+)|;'`

# Define $BRANCH_NAME if all the above succeeded
if [ -n "$REPO" -a -n "$BRANCH" ]; then
  export BRANCH_NAME=${BRANCH}
else
  export BRANCH_NAME=UNKNOWN
fi

# ----- BRANCH_URL = https://svn.astron.nl/LOFAR/branches/LOFAR-Task1234 -----
# ----- BRANCH_URL = https://svn.astron.nl/LOFAR/trunk -----
# ----- BRANCH_URL = https://svn.astron.nl/LOFAR/tags/LOFAR-Release-2_15_1 -----

export BRANCH_URL="$URL"

# ----- REVISION = 12345 -----

if [ "{$BRANCH}" == "trunk" ]; then
  # Friendly special case to be able to export the output to 3rd parties.
  # They'll want the HEAD instead of the revision we happened to build with,
  # and we'll don't care that much for the race condition it causes for us
  # (between generating the output and using it)
  export REVISION=HEAD
else
  export REVISION=`echo "$SVN_INFO" | perl -ne 'print "$1" if /Revision: +(.+)/;'`
fi

# ----- NOW = 2016-01-01 10:11:12 -----

export NOW="`date -u +'%F %T'`"

# ----- BUILD_UID = 1001 ----

export BUILD_UID=`id -u`

# ----- Process input -----

# Insert our knowledge when processing stdin -> stdout
envsubst '$BRANCH_NAME $BRANCH_URL $REVISION $NOW $BUILD_UID'

