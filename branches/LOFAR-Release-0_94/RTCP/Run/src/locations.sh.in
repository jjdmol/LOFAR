function isproduction() {
  [ "lofarsys" == "$USER" ]
}

TIMESTAMP=`date +%Y-%m-%d_%H%M%S`

if [ -z "$LOFARROOT" ]
then
  LOFARROOT=/opt/lofar
fi

if [ -z "$OBSID" ]
then
  OBSID='${OBSID}'
fi

ETCDIR=$LOFARROOT/etc

source $ETCDIR/BlueGeneControl.conf

if isproduction
then
  ISPRODUCTION=1

  CNPROC=$HOME/production/lofar/bgp_cn/bin/CN_Processing
  IONPROC=$HOME/production/lofar/bgp_ion/bin/ION_Processing
  STORAGE=/data/home/lofarsys/production/lofar/bin/Storage_main

  LOGDIR=/localhome/log
  RUNDIR=/globalhome/lofarsystem
  LOGBACKUPDIR=/globalhome/lofarsystem/log-archive
  LOGPARAMS="-s ccu001:24500"

  IONPROC_PARSET="/bghome0/lofarsys/parsets/L$OBSID.parset"
  STORAGE_PARSET="/globalhome/lofarsystem/log/L$OBSID/L$OBSID.parset"
  EXTRA_KEYS="
OLAP.Storage.parsetFilename = $STORAGE_PARSET
OLAP.Storage.userName = lofarsys
OLAP.Storage.sshIdentityFile = /globalhome/lofarsystem/.ssh/id_rsa
OLAP.Storage.msWriter=$STORAGE
OLAP.Storage.AntennaSetsConf = /data/home/lofarsys/production/lofar/etc/AntennaSets.conf
OLAP.Storage.AntennaFieldsDir = /data/home/lofarsys/production/lofar/etc/StaticMetaData
OLAP.Storage.HBADeltasDir = /data/home/lofarsys/production/lofar/etc/StaticMetaData

OLAP.IONProc.PLC_controlled = T
OLAP.CNProc.partition = $PARTITION
  "
else
  ISPRODUCTION=0

  CNPROC=$HOME/projects/LOFAR/installed/bgpcn_opt/bin/CN_Processing
  IONPROC=$HOME/projects/LOFAR/installed/bgpion_opt/bin/ION_Processing
  STORAGE=$HOME/projects/LOFAR/installed/gnu_opt/bin/Storage_main

  LOGDIR=$HOME/projects/LOFAR/log
  RUNDIR=$LOGDIR
  LOGBACKUPDIR=$LOGDIR
  LOGPARAMS="-v"

  IONPROC_PARSET="$LOGDIR/L$OBSID.parset"
  STORAGE_PARSET="$LOGDIR/L$OBSID.parset"
  EXTRA_KEYS="
OLAP.Storage.parsetFilename = $STORAGE_PARSET
OLAP.Storage.userName = $USER
OLAP.Storage.sshIdentityFile = $HOME/.ssh/id_rsa
OLAP.Storage.msWriter = $STORAGE
OLAP.Storage.AntennaSetsConf = /data/home/lofarsys/production/lofar/etc/AntennaSets.conf
OLAP.Storage.AntennaFieldsDir = /data/home/lofarsys/production/lofar/etc/StaticMetaData
OLAP.Storage.HBADeltasDir = /data/home/lofarsys/production/lofar/etc/StaticMetaData

OLAP.IONProc.PLC_controlled = F
OLAP.CNProc.partition = $PARTITION
  "
fi


function set_psetinfo() {
  # list both the partition directly (small partitions) and recursively (large partitions) to get all -32 subpartitions
  # bghierarchy needs a valid stdin for some reason and will read from it, so provide a fake one
  if [ "$PARTITION" == "R00R01" ]
  then
    SUBPARTITIONS="`(bghierarchy -s R00 R01;bghierarchy -s \`bghierarchy -s R00 R01\`) </dev/null`"
  else
    SUBPARTITIONS="`(bghierarchy -s $PARTITION;bghierarchy -s \`bghierarchy -s $PARTITION\`) </dev/null`"
  fi  

  # a comma-separated list of all psets in $PARTITION
  # xxx-32 means both xxx-J00 and xxx-J01
  PSETS=`for i in $SUBPARTITIONS; do echo $i; done|grep -- "-32$"|sort -u|sed 's/-32$/-J00/;p;s/-J00$/-J01/'|xargs -L 1 host -4|cut -d\  -f 4|tr '\n' ','`

  # the address of the first pset in the $PARTITION
  FIRSTPSET=`for i in $SUBPARTITIONS; do echo $i; done|grep -- "-32$"|sort -u|sed 's/-32$/-J00/;p;s/-J00$/-J01/'|xargs -L 1 host -4|cut -d\  -f 4|head -n 1`
}

