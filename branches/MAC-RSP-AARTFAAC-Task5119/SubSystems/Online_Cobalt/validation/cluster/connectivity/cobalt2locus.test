#!/bin/sh -xe
#
# Test connectivity from Cobalt to the Locus nodes locus001..locus100
#
# This test is a big awkward, because we cannot assume that every locus node
# is online. Therefore, we execute the same command, using cexec, both
# from the CEP2 head node (lhn001), and from the current node. The outputs
# should be the same.
#
# $Id$

# Handle common signals
trap 'rm -f -- $C3_CONF; exit' 0 1 2 3 15

# Execute all remote commands with a timeout. Use a decent timeout (15 sec);
# some locus nodes may be sluggish when running pipelines
TIMEOUT="timeout 15"

# Define SSH, SCP
SSH="$TIMEOUT ssh"
SCP="$TIMEOUT scp"
CEXEC="$TIMEOUT $(cd ../c3 && pwd)/cexec"

# Get the location of cexec on lhn001
C3_PATH=$(dirname $($SSH lhn001 which cexec))

# Location of our temporary c3.conf file
C3_CONF=$(tempfile -p "c3." -s ".conf")

# Retrieve the c3.conf file from lhn001.
$SCP lhn001:/etc/c3.conf $C3_CONF

# Retrieve the list of locus nodes reachable from lhn001
LHN_LOCUS=$($SSH lhn001 cexec locus: hostname | grep '^locus')

# Retrieve the list of locus nodes reachable from localhost
CBM_LOCUS=$(C3_PATH=$C3_PATH $CEXEC -f $C3_CONF locus: hostname | grep '^locus')

# Compare the results.
[ "$LHN_LOCUS" = "$CBM_LOCUS" ]
