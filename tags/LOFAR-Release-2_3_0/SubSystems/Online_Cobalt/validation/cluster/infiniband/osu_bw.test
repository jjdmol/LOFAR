#!/bin/bash
#
# Test script that measures the point-to-point throughput between two nodes
# using MPI and compares it to reference data. The test is considered
# successfull if, for every message size, either:
# - the difference between reference and measured throughput is less than
#   10 MB/s, or
# - the ratio between measured output and reference is larger than 95%.
#
# NOTE: The osu_bw program is part of the OSU Micro Benchmark, which
# can be downloaded from http://mvapich.cse.ohio-state.edu/benchmarks/
#
# $Id$

cd $(dirname $0)

export LD_LIBRARY_PATH=/opt/openmpi/lib:$LD_LIBRARY_PATH
export PATH=/opt/openmpi/bin:$PATH

# Set absolute and relative thresholds for throughput comparison.
ABS_THRESHOLD=10
REL_THRESHOLD=0.95

# Build the osu_bw program if needed
OSU_BW=$(./build_osu.sh) || exit

# Run the benchmark
mpirun -H localhost,localhost bash -l -c $OSU_BW > osu_bw.out

# Compare with reference output
# - first make sure we used the same version of the OSU benchmark test
# - next compare numbers, taking threshold into account.
diff <(grep '^#' osu_bw.ref) <(grep '^#' osu_bw.out) || exit
paste \
  <(grep '^[0-9]' osu_bw.ref) <(grep '^[0-9]' osu_bw.out) | \
   awk -v ABS_THRESHOLD=$ABS_THRESHOLD \
       -v REL_THRESHOLD=$REL_THRESHOLD '{
    if ($1 != $3) {
      print "Alignment error comparing test output: " \
            "expected size "$1", got "$3;
      error = 1; 
    }
    if (($4 < $2 - ABS_THRESHOLD) && ($4 < $2 * REL_THRESHOLD)) {
      print "Bandwidth too low for block size "$1": " \
            "expected "$2" MB/s, got "$4" MB/s";
      error = 1;
    }
  } END { exit error; }'
