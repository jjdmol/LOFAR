#!/bin/sh

#
# Path to the wrapexec_wrapper binary
#
wrapexec_wrapper=INSTALL_BINDIR/wrapexec_wrapper

#
# Test for correct usage
#
if test $# -ne 2; then
	echo "Usage: wrapexec /path/to/program_to_wrap <toolname>."
	echo "Example: wrapexec ./mytest ddd"
	echo "<toolname> can be one of:"
	tools=`grep "^\[.*" ~/.wrapexec | sed -e 's/^\[//'  | sed 's/\]$//' `
	for t in $tools; do
		echo -e "       \t$t";
	done;
	exit 1;
fi

#
# Copy arguments
#
program=$1
shift
toolname=$1
shift

#
# Test whether the program has already been wrapped by comparing inodes
#
wrapexec_inode=`ls -iL $wrapexec_wrapper | cut -d\  -f1`
program_inode=`ls -iL $program | cut -d\  -f1`
if test $program_inode -eq $wrapexec_inode; then
	existing_toolname=`ls -1 $program.wrap_* | cut -d_ -f2`
	echo "wrapexec: error: program '$program' already wrapped by '$existing_toolname'"
	exit 1;
fi

#
# Wrap!
#
mv $program $program.wrap_$toolname
ln -s $wrapexec_wrapper $program

