#!/bin/sh
# this script must be called with nriter and usernm

TESTNAME=testEJ11Polyn

if [ "$#" != "1" ]; then
 echo "not the correct number of parameters"
 exit 1
fi

usernm=$1

. ./initparms

# Do ${TESTNAME}
echo ""
echo "Doing ${TESTNAME}"

# read variables from ParameterSet
PSET=tBBS3.${TESTNAME}
DBTYPE=`../../src/psReader $PSET CTRLparams.SC1params.MSDBparams.DBType`
MEQTN=`../../src/psReader $PSET CTRLparams.SC1params.MSDBparams.meqTableName`
GSMTN=`../../src/psReader $PSET CTRLparams.SC1params.MSDBparams.skyTableName`

echo "  Generating parm tables ..."
# use functions in initparms to initialize parmtables
beginParmdbInputFile "dbtype='$DBTYPE', user='$usernm', tablename='$MEQTN'"
makeMeq
makeEJ11Poly
applyfile

beginParmdbInputFile "dbtype='$DBTYPE', user='$usernm', tablename='$GSMTN'"
makeGsm
perturbGsm
applyfile

echo "  Preparing BlackBoard ..."
time ./clearBB -user $usernm
echo "  Starting solve ..."
# time ./tBBS3 tBBS3.${TESTNAME} $usernm >& ${TESTNAME}.out

echo "localhost" > tBBS3_tmp.machinefile
echo "localhost" >> tBBS3_tmp.machinefile
echo "localhost" >> tBBS3_tmp.machinefile
echo "localhost" >> tBBS3_tmp.machinefile
#./tBBS3 tBBS3.${TESTNAME} $usernm >& ${TESTNAME}.out
#  mpirun -np 3 -machinefile tBBS3_tmp.machinefile tBBS3 tBBS3.${TESTNAME} $usernm >& ${TESTNAME}.out

mpirun_mpich -np 3 -machinefile tBBS3_tmp.machinefile tBBS3 $PSET $usernm  &> ${TESTNAME}.out
